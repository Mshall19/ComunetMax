version: '3.8'

services:
  # ------------------------------------------------------------
  # 1. BASE DE DATOS (MySQL)
  # ------------------------------------------------------------
  mysqldb:
    image: mysql:8.0
    container_name: mysqldb
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: db_proyecto_final
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql

  # ------------------------------------------------------------
  # 2. CONFIG SERVER (Debe iniciar primero)
  # ------------------------------------------------------------
  ms-config-server:
    build: ./ms-config-server
    container_name: ms-config-server
    ports:
      - "8888:8888"
    environment:
      # Perfil nativo para que lea archivos locales si no usas Git
      - SPRING_PROFILES_ACTIVE=native
    depends_on:
      - mysqldb

  # ------------------------------------------------------------
  # 3. MICROSERVICIOS DE NEGOCIO
  # ------------------------------------------------------------
  ms-usuarios:
    build: ./ms-usuarios
    container_name: ms-usuarios
    restart: on-failure
    environment:
      # Sobrescribimos localhost por el nombre del contenedor de la BD
      SPRING_DATASOURCE_URL: jdbc:mysql://mysqldb:3306/db_proyecto_final
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      # Conexión al Config Server
      SPRING_CONFIG_IMPORT: "optional:configserver:http://ms-config-server:8888"
    depends_on:
      - mysqldb
      - ms-config-server

  ms-empresas:
    build: ./ms-empresas
    container_name: ms-empresas
    restart: on-failure
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysqldb:3306/db_proyecto_final
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      SPRING_CONFIG_IMPORT: "optional:configserver:http://ms-config-server:8888"
    depends_on:
      - mysqldb
      - ms-config-server

  ms-planes:
    build: ./ms-planes
    container_name: ms-planes
    restart: on-failure
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://mysqldb:3306/db_proyecto_final
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
      SPRING_CONFIG_IMPORT: "optional:configserver:http://ms-config-server:8888"
    depends_on:
      - mysqldb
      - ms-config-server

  # ------------------------------------------------------------
  # 4. API GATEWAY (El portero)
  # ------------------------------------------------------------
  ms-gateway:
    build: ./ms-gateway
    container_name: ms-gateway
    ports:
      - "8080:8080"
    environment:
      SPRING_CONFIG_IMPORT: "optional:configserver:http://ms-config-server:8888"
      # Aquí defines dónde está cada servicio para que el Gateway sepa enrutar
      # (Si usas Eureka esto es automático, si no, se define manual en properties)
      EUREKA_CLIENT_ENABLED: "false"
    depends_on:
      - ms-config-server
      - ms-usuarios
      - ms-empresas
      - ms-planes

volumes:
  mysql_data: